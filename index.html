<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stellar ✨</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; 
            background: radial-gradient(circle at center, #0a0a12 0%, #000 100%);
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #fff;
            overflow-x: hidden; /* Evita scroll horizontal */
        }

        /* Solo permitimos scroll si el contenido es muy alto (ej. en horizontal) */
        body.game-active { overflow: hidden; }

        #cursor-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.07) 0%, transparent 60%);
            pointer-events: none; z-index: 1;
        }

        .header { margin-top: 20px; text-align: center; z-index: 10; padding: 0 10px; flex-shrink: 0; }

        h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 1.8rem; margin: 0; color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .score-board { font-size: 0.6rem; margin-top: 5px; opacity: 0.5; letter-spacing: 2px; text-transform: uppercase; }

        #game-container { 
            position: relative; 
            flex-grow: 1; 
            width: 100%; 
            min-height: 300px;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 5; 
        }

        #victory-panel {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center; opacity: 0; pointer-events: none;
            transition: all 0.6s ease; width: 90%; max-width: 500px; z-index: 100;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            padding: 20px; border-radius: 20px;
        }

        #victory-panel.show { opacity: 1; pointer-events: auto; }
        
        #victory-panel p { 
            font-size: 1.1rem; font-weight: 100; line-height: 1.5; 
            color: #fff; margin-bottom: 20px;
        }

        .spotify-wrapper {
            margin: 20px 0;
            width: 90%; max-width: 300px; height: 80px; z-index: 10; opacity: 0.6;
            flex-shrink: 0;
        }

        .btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; padding: 12px 24px; border-radius: 50px;
            cursor: pointer; font-size: 0.75rem;
            text-transform: uppercase; letter-spacing: 1px;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { background: #fff; color: #000; }

        canvas#starCanvas { touch-action: none; display: block; }
    </style>
</head>
<body class="game-active">

    <div id="cursor-glow"></div>

    <div class="header">
        <h1>Mi creador de estrellas</h1>
        <div class="score-board">Conexión: <span id="score">0</span></div>
    </div>

    <div id="game-container">
        <canvas id="starCanvas"></canvas>
        <div id="victory-panel">
            <p id="phrase"></p>
            <div id="controls">
                <button id="nextBtn" class="btn">Continuar</button>
                <button id="retryBtn" class="btn" style="display: none;">"Te volvería a elegir"</button>
            </div>
        </div>
    </div>

    <div class="spotify-wrapper">
        <iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/track/2plbrEY59IikOBgBGLjaoe?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
    </div>

<script>
    const canvas = document.getElementById('starCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const victoryPanel = document.getElementById('victory-panel');
    const phraseElement = document.getElementById('phrase');
    const nextBtn = document.getElementById('nextBtn');
    const retryBtn = document.getElementById('retryBtn');

    let score = 0; let currentLevel = 0; let connectedIndices = []; 
    let gameParticles = []; let bgParticles = []; let isGameFinished = false;

    // Ajuste dinámico de resolución y tamaño
    function resize() {
        const dpr = window.devicePixelRatio || 1;
        const container = document.getElementById('game-container');
        const rect = container.getBoundingClientRect();
        
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(dpr, dpr);
        
        initBg(); // Repoblar estrellas de fondo al girar
    }

    function initBg() {
        bgParticles = [];
        const w = canvas.width / (window.devicePixelRatio || 1);
        const h = canvas.height / (window.devicePixelRatio || 1);
        for(let i=0; i<40; i++) bgParticles.push({
            x: Math.random() * w, y: Math.random() * h,
            size: Math.random() * 1.2, opacity: Math.random()
        });
    }

    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', () => setTimeout(resize, 200));

    // Lógica de Niveles (Normalizada de 0 a 100)
    const rawLevels = [
        { phrase: "Para quien buscaba a su hermanita y terminó creando un hogar", points: [{x:50,y:20},{x:50,y:35},{x:30,y:25},{x:25,y:40},{x:50,y:50},{x:75,y:40},{x:70,y:25},{x:50,y:35},{x:50,y:80},{x:50,y:95}] },
        { phrase: "Todos merecen una segunda oportunidad", points: [{x:50,y:80},{x:35,y:65},{x:30,y:40},{x:38,y:20},{x:48,y:30},{x:50,y:25},{x:52,y:30},{x:62,y:20},{x:70,y:40},{x:65,y:65},{x:50,y:80}] },
        { phrase: "Encontramos ternura donde menos lo esperamos", points: [{x:30,y:20},{x:45,y:35},{x:38,y:50},{x:40,y:80},{x:60,y:80},{x:62,y:50},{x:55,y:35},{x:70,y:20},{x:55,y:35},{x:45,y:35},{x:50,y:60}] },
        { phrase: "No hay océano tan grande para medir el amor que siento por ti", points: [{x:20,y:60},{x:30,y:80},{x:55,y:80},{x:80,y:60},{x:95,y:50},{x:95,y:70},{x:80,y:60},{x:65,y:40},{x:35,y:40},{x:20,y:60}] },
        { phrase: "Hasta el corazón más helado se derrite a tu lado", points: [{x:25,y:30},{x:38,y:45},{x:62,y:45},{x:80,y:20},{x:70,y:60},{x:80,y:90},{x:62,y:80},{x:45,y:80},{x:30,y:65},{x:25,y:55},{x:38,y:45}] },
        { phrase: "Para el hombre que dejó todo por la mujer que amaba", points: [{x:40,y:50},{x:40,y:35},{x:50,y:25},{x:60,y:35},{x:60,y:50},{x:50,y:58},{x:40,y:50},{x:50,y:58},{x:40,y:66},{x:40,y:82},{x:50,y:90},{x:60,y:82},{x:60,y:66},{x:50,y:58}] },
        { phrase: "La máquina con más amor que he conocido", points: [{x:50,y:80},{x:30,y:50},{x:38,y:25},{x:50,y:38},{x:62,y:25},{x:70,y:50},{x:50,y:80}] },
        { phrase: "Con quien mi corazón dejó de correr", points: [{x:50,y:50},{x:62,y:35},{x:50,y:50},{x:70,y:50},{x:50,y:50},{x:62,y:65},{x:50,y:50},{x:38,y:35},{x:50,y:50},{x:30,y:50},{x:50,y:50},{x:38,y:65},{x:50,y:50}] }
    ];

    function getLogicalPoints() {
        const w = canvas.width / (window.devicePixelRatio || 1);
        const h = canvas.height / (window.devicePixelRatio || 1);
        return rawLevels[currentLevel].points.map(p => ({
            x: (p.x * w) / 100, y: (p.y * h) / 100
        }));
    }

    class Particle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.size = Math.random() * 2 + 1;
            this.speedX = (Math.random() - 0.5) * 4;
            this.speedY = (Math.random() - 0.5) * 4;
            this.alpha = 1;
        }
        update() { this.x += this.speedX; this.y += this.speedY; this.alpha -= 0.03; }
        draw() {
            ctx.save(); ctx.globalAlpha = this.alpha;
            ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            ctx.restore();
        }
    }

    function animate() {
        const w = canvas.width / (window.devicePixelRatio || 1);
        const h = canvas.height / (window.devicePixelRatio || 1);
        ctx.clearRect(0, 0, w, h);
        
        bgParticles.forEach(p => {
            ctx.fillStyle = `rgba(255,255,255,${p.opacity * Math.abs(Math.sin(Date.now()*0.001))})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
        });

        if(!isGameFinished) {
            const pts = getLogicalPoints();
            if (connectedIndices.length > 1) {
                ctx.beginPath(); ctx.lineWidth = 1.5; ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
                for (let i = 0; i < connectedIndices.length; i++) {
                    const p = pts[connectedIndices[i]];
                    if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
                }
                ctx.stroke();
            }
            pts.forEach((p, index) => {
                const isDone = connectedIndices.includes(index);
                const isNext = index === connectedIndices.length;
                ctx.fillStyle = isDone ? "#fff" : (isNext ? "rgba(255,255,255,1)" : "rgba(255,255,255,0.15)");
                ctx.beginPath(); ctx.arc(p.x, p.y, isDone ? 4 : 3, 0, Math.PI * 2); ctx.fill();
            });
        }
        gameParticles = gameParticles.filter(p => p.alpha > 0);
        gameParticles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
    }

    function handleInput(e) {
        if(isGameFinished || victoryPanel.classList.contains('show')) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const mouseX = clientX - rect.left;
        const mouseY = clientY - rect.top;
        
        const pts = getLogicalPoints();
        const index = connectedIndices.length;
        if(index < pts.length) {
            const p = pts[index];
            if(Math.hypot(mouseX - p.x, mouseY - p.y) < 45) {
                connectedIndices.push(index);
                score += 50; scoreElement.innerText = score;
                for(let i=0; i<10; i++) gameParticles.push(new Particle(p.x, p.y));
                if (connectedIndices.length === pts.length) {
                    setTimeout(() => {
                        phraseElement.innerText = rawLevels[currentLevel].phrase;
                        victoryPanel.classList.add('show');
                        document.body.classList.remove('game-active'); // Permitir scroll para leer
                    }, 400);
                }
            }
        }
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
    canvas.addEventListener('mousedown', handleInput);

    nextBtn.addEventListener('click', () => {
        victoryPanel.classList.remove('show');
        document.body.classList.add('game-active');
        if(currentLevel === rawLevels.length - 1) {
            isGameFinished = true;
            setTimeout(() => {
                phraseElement.innerText = "Feliz San Valentín. Gracias por crear estrellas a mi lado.";
                nextBtn.style.display = "none";
                retryBtn.style.display = "inline-block";
                victoryPanel.classList.add('show');
                document.body.classList.remove('game-active');
            }, 500);
        } else {
            currentLevel++; connectedIndices = [];
        }
    });

    retryBtn.addEventListener('click', () => {
        victoryPanel.classList.remove('show');
        document.body.classList.add('game-active');
        setTimeout(() => {
            currentLevel = 0; connectedIndices = []; isGameFinished = false;
            score = 0; scoreElement.innerText = score;
            nextBtn.style.display = "inline-block";
            retryBtn.style.display = "none";
        }, 800);
    });

    resize();
    animate();
</script>
</body>
</html>